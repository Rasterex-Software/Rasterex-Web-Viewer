!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("PDFViewCtrl"),require("PDFViewCtrl").commons):"function"==typeof define&&define.amd?define(["PDFViewCtrl",["PDFViewCtrl","commons"]],t):"object"==typeof exports?exports.PDFViewCtrl_EditGraphicsAddonModule=t(require("PDFViewCtrl"),require("PDFViewCtrl").commons):e.PDFViewCtrl_EditGraphicsAddonModule=t(e.PDFViewCtrl,e.PDFViewCtrl.commons)}(self,((e,t)=>(()=>{"use strict";var n={778:t=>{t.exports=e},457:e=>{e.exports=t}},r={};function i(e){var t=r[e];if(void 0!==t)return t.exports;var o=r[e]={exports:{}};return n[e](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return(()=>{function e(t,n){return null!=n&&"undefined"!=typeof Symbol&&n[Symbol.hasInstance]?!!n[Symbol.hasInstance](t):e(t,n)}function t(t,n){if(!e(t,n))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function r(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}i.r(o),i.d(o,{EditGraphicsAddon:()=>pt,EditGraphicsAddonEvents:()=>w});var a=i(778);function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function s(e,t,n){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n||e):i.value}},s(e,t,n||e)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}function h(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=c(e);if(t){var i=c(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return h(this,n)}}const f={print:4,modify:8,extract:16,annotForm:32,fillForm:256,extractAccess:512,assemble:1024,printHigh:2048};var p=a.Deps.jQuery,v=a.shared.browser.getPtPxRatio,E=a.Events,g=(a.shared.activation.ActivationGroup,a.commons.notImplemented),_=(a.PDF.engine.GraphicsObject,a.keyboard),m=_.BuiltinShortcutContext,T=_.BuiltinCommand,A=function(n){l(o,n);var i=d(o);function o(e,n,r){var a;return t(this,o),(a=i.call(this)).isDestroyed=!1,a.graphicsObject=e,a.pageRender=n,a.dependences=r,a}return r(o,[{key:"doActive",value:function(){var e=this.$handler,t=this.dependences.pdfViewer;if(!e){e=this.initUI(),this.$handler=e;var n=this.getContextMenuConfig();n&&!this.contextmenu&&(this.contextmenu=t.viewerUI.createContextMenu(this,e.get(0),n))}e.addClass("fwr__active"),this.updateShapeControl(),this.bindEvent()}},{key:"getContextMenuConfig",value:function(){}},{key:"getContextMenuComponentName",value:function(){g()}},{key:"removeGraphicObject",value:function(){this.remove()}},{key:"remove",value:function(){var e=this;if(this.isActive){this.removeToolbar&&this.removeToolbar();var t=this.dependences.pdfViewer;t.getAllActiveElements().forEach((function(t){t.unActive(),t!==e&&t.remove&&t.remove()})),0===t.getAllActiveElements().length&&t.activeElement()}}},{key:"removeGraphicObjects",value:function(e){for(var t=e.length-1;t>=0;t--){var n=e[t];if(n.removeToolbar&&n.removeToolbar(),n.unActive(),n.dependences.pdfViewer.unActiveElement(n),n.destroy(),!n.graphicsObject.doc.checkPermission(f.modify))throw new Error("Permission error");var r=0===t;n.graphicsObject.getPDFPage().removeGraphicsObjectEx(n.graphicsObject,r)}this.dependences.pdfViewer.activeElement()}},{key:"bindEvent",value:function(){var e=this,t=this.dependences.pdfViewer;t.getKeyboard().withContext(m.ACTIVATION_ANY,(function(n){e.isDestroyed||(e.__off__delete__event__=n.keydown(T.DELETE_SELECTED_OBJECT,(function(n){var r=t.getAllActiveElements();r.length>1?e===r[r.length-1]&&e.removeGraphicObjects(r):e.removeGraphicObject(),e.__off__delete__event__()})),e.__off__esc__event__=n.keydown(T.UNSELECT_OBJECT,(function(t){e.unActive(!0)})))}))}},{key:"unBindEvent",value:function(){this.__off__delete__event__&&this.__off__delete__event__(),this.__off__delete__event__=function(){},this.__off__esc__event__&&this.__off__esc__event__(),this.__off__esc__event__=function(){},this.__off_active_escape_event&&this.__off_active_escape_event(),delete this.__off_active_escape_event}},{key:"translateContextMenuName",value:function(e){for(var t in e)if("items"===t){var n=e[t],r=this.dependences.pdfViewer.i18n;for(var i in n){var o=n[i];o.nameI18nKey&&(o.name=r.t(o.nameI18nKey))}}return e}},{key:"updateShapeControl",value:function(){var e=this.getBoundary(),t=this._getShapeControllerBoundaryBox();this.shapeControl&&this.shapeControl.active(this.$handler,e,t)}},{key:"unActive",value:function(){this.isActive&&(s(c(o.prototype),"unActive",this).call(this),this.$handler&&(this.$handler.removeClass("fwr__active"),this.shapeControl&&this.shapeControl.deactive(),this.dependences.pdfViewer.eventEmitter.off(E.fitWidthResizeViewport,this.afterZoom),this.dependences.pdfViewer.eventEmitter.off(E.zoomToSuccess,this.afterZoom),this.$handler&&this.$handler.remove(),this.$handler=null,this.unBindEvent(),this.$charEditContainer&&this.$charEditContainer.off("focus"),this.removeToolbar&&this.removeToolbar()))}},{key:"doDeactive",value:function(){}},{key:"destroy",value:function(){this.isDestroyed=!0,this.unActive(),this.shapeControl&&this.shapeControl.destroy(),this.contextmenu&&this.contextmenu.destroy()}},{key:"getModel",value:function(){return this.graphicsObject}},{key:"_getShapeControllerBoundaryBox",value:function(){var e,t=this.pageRender.page,n=v()*this.pageRender.getScale(),r=[t.getPxWidth()*n,t.getPxHeight()*n],i=r[0],o=r[1];this.pageRender.rotate%180!=0&&(o=(e=[i,o])[0],i=e[1]);return{left:0,top:0,width:i,height:o}}},{key:"getBoundary",value:function(){var e=this.pageRender.page,t=this.graphicsObject.getRect(),n=e.getDeviceRect(t,this.pageRender.getScale(),this.pageRender.getRotation());return{left:n.left,top:n.top,width:n.right-n.left,height:n.bottom-n.top}}},{key:"initUI",value:function(){var e=this;if(!this.$handler){var t=this.$handler=p('<div class="fwr__graphics-object-handler"\n        ></div>');this.pageRender.pageHandler.$handler.append(t),t.get(0).__graphics_object_component=this;var n=!0;return this.predefineTextObject&&(n=!1),this.shapeControl=new a.ShapeControl({prestart:function(){return e.onPrestart()},start:function(t,n,r){return e.onStartUpdateShape(t,n,r)},moving:function(t,n,r){var i=r.offsetX,o=r.offsetY;return e.onShapeMoving(t,n,i,o)},update:function(t,n){return e.onShapeUpdating(t,n)},end:function(t,n,r,i){return e.onShapeUpdateEnd(t,n,r,i)},afterEnd:function(t){return e.onAfterShapeCtrlEnd(t)},resizable:n,enableDiagonally:!0,enableFrame:!0,previewer:!0,auxiliaryLine:void 0}),this.dependences.pdfViewer.eventEmitter.on(E.zoomToSuccess,this.afterZoom=function(){e.updateShapeControl()}),this.dependences.pdfViewer.eventEmitter.on(E.fitWidthResizeViewport,this.afterZoom),this.$handler}}},{key:"onPrestart",value:function(){var t=this;this.dependences.pdfViewer.getAllActiveElements().forEach((function(n){n!==t&&e(n,o)&&t.shapeControl.companion(n.shapeControl)}))}},{key:"onAfterShapeCtrlEnd",value:function(e){this.shapeControl.clearCompanions()}},{key:"onStartUpdateShape",value:function(e,t,n){var r=this;if("move"){if(this.dependences.pdfViewer.getAllActiveElements().length>1||!this.graphicsObject.getBitmap)return;p(this.shapeControl.ui.querySelector(".fv__shape-control-previewer")).show(),this.graphicsObject.getBitmap(this.pageRender.getScale(),this.pageRender.getRotation()).then((function(e){if(e){var t=r.shapeControl.getPreviewerContext();p(t.canvas).attr({width:e.width,height:e.height});var n=t.createImageData(e.width,e.height+1),i=new(Uint8ClampedArray||Uint8Array)(e.buffer);n.data.set(i),t.putImageData(n,0,0)}}))}}},{key:"onShapeMoving",value:function(e,t){}},{key:"onShapeUpdating",value:function(e,t){}},{key:"onShapeUpdateEnd",value:function(e,t,n){var r=this,i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],o=Object.assign({},e);o.right=o.left+o.width,o.bottom=o.top+o.height,o=this.pageRender.page.reverseDeviceRect(o,this.pageRender.getScale(),this.pageRender.getRotation()),this.graphicsObject.setRect(o,i).then((function(e){p(r.shapeControl.ui.querySelector(".fv__shape-control-previewer")).hide(),r.updateShapeControl()}))}},{key:"setColor",value:function(e){return this.graphicsObject.setBorderColor(e)}},{key:"setBorderStyle",value:function(e,t){var n=this;return this.graphicsObject.setBorderStyle(e,t).then((function(e){n.updateShapeControl()}))}},{key:"setOpacity",value:function(e){return this.graphicsObject.setOpacity(e)}},{key:"setFillColor",value:function(e){return this.graphicsObject.setFillColor(e)}},{key:"setBorderWidth",value:function(e){var t=this;return this.graphicsObject.setBorderWidth(e).then((function(e){t.updateShapeControl()}))}},{key:"moveToPosition",value:function(e,t){var n=this;return this.graphicsObject.moveToPosition(e,t).then((function(e){n.updateShapeControl()}))}},{key:"getGraphicsObject",value:function(){return this.graphicsObject}}]),o}(a.shared.activation.Activatable);function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function C(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function R(e,t){if(e){if("string"==typeof e)return C(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?C(e,t):void 0}}function S(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o=[],a=!0,c=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);a=!0);}catch(e){c=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(c)throw i}}return o}}(e,t)||R(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}const w={textObjectActive:"text-object-active",textObjectUnActive:"text-object-unactive",addTextObjectParamTransfer:"add-text-object-param-transfer"};var b,x={};"function"==typeof FontFace?b=function(e,t){return x[e]?x[e]:x[e]=new Promise((function(n,r){t().then((function(t){if(!t)return r(),void x[e];var i=new FontFace(e,t.buffer||t.url);i.load().then((function(){document.fonts.add(i),n(i)}),(function(){r(),delete x[e]}))}),(function(){r(),delete x[e]}))}))}:b=function(e,t){return x[e]?x[e]:x[e]=new Promise((function(n,r){t().then((function(t){return t?t.buffer?URL.createObjectURL(new Blob([t.buffer],"application/x-font-woff")):t.url:(r("woff is invalid"),void delete x[e])})).then((function(t){if(!t)return r();var i=document.createElement("style");i.innerHTML='@font-face{font-family:"'+e+'"; src:url("'+t+'");}',document.head.appendChild(i),n(i)}))}))};var H;!function(e){e.STATE_HANDLER_HAND="hand",e.STATE_HANDLER_CHECK_THE_SEARCH="checkTheSearch",e.STATE_HANDLER_CREATE_CARET="createCaret",e.STATE_HANDLER_CREATE_ARROW="createArrow",e.STATE_HANDLER_CREATE_AREA_HIGHLIGHT="createAreaHighlight",e.STATE_HANDLER_CREATE_CREATE_AREA_HIGHLIGHT="createAreaHighlight",e.STATE_HANDLER_CREATE_CIRCLE="createCircle",e.STATE_HANDLER_CREATE_FILE_ATTACHMENT="createFileAttachment",e.STATE_HANDLER_CREATE_HIGHLIGHT="createHighlight",e.STATE_HANDLER_CREATE_IMAGE="createImage",e.STATE_HANDLER_CREATE_LINK="createLink",e.STATE_HANDLER_CREATE_LINE="createLine",e.STATE_HANDLER_CREATE_DISTANCE="createDistance",e.STATE_HANDLER_CREATE_PERIMETER="createPerimeter",e.STATE_HANDLER_CREATE_AREA="createArea",e.STATE_HANDLER_CREATE_CIRCLE_AREA="createCircleArea",e.STATE_HANDLER_CREATE_PENCIL="createPencil",e.STATE_HANDLER_CREATE_POLYGON_CLOUD="createPolygonCloud",e.STATE_HANDLER_CREATE_POLYGON="createPolygon",e.STATE_HANDLER_CREATE_POLYLINE="createPolyline",e.STATE_HANDLER_CREATE_REPLACE="createReplace",e.STATE_HANDLER_CREATE_SQUARE="createSquare",e.STATE_HANDLER_CREATE_SQUIGGLY="createSquiggly",e.STATE_HANDLER_CREATE_STAMP="createStamp",e.STATE_HANDLER_CREATE_STRIKE_OUT="createStrikeOut",e.STATE_HANDLER_CREATE_TEXT="createText",e.STATE_HANDLER_CREATE_UNDERLINE="createUnderline",e.STATE_HANDLER_MARQUEE="marquee",e.STATE_HANDLER_ERASER="eraser",e.STATE_HANDLER_LOUPE="loupe",e.STATE_HANDLER_SELECT_TEXT_ANNOTATION="select-text-annotation",e.STATE_HANDLER_SELECT_TEXT_IMAGE="select-text-image",e.STATE_HANDLER_SELECT_ANNOTATION="select-annotation",e.STATE_HANDLER_CREATE_FREETEXT_BOX="createFreeTextBox",e.STATE_HANDLER_CREATE_FREETEXT_CALLOUT="createFreeTextCallout",e.STATE_HANDLER_CREATE_FREETEXT_TYPEWRITER="createFreeTextTypewriter",e.STATE_HANDLER_CREATE_FIELD_TEXT="CreateTextStateHandler",e.STATE_HANDLER_CREATE_FIELD_SIGNATURE="CreateSignStateHandler",e.STATE_HANDLER_CREATE_FIELD_PUSH_BUTTON="CreatePushButtonStateHandler",e.STATE_HANDLER_CREATE_FIELD_CHECK_BOX="CreateCheckBoxStateHandler",e.STATE_HANDLER_CREATE_RADIO_BUTTON="CreateRadioButtonStateHandler",e.STATE_HANDLER_CREATE_FIELD_COMBO_BOX="CreateComboBoxStateHandler",e.STATE_HANDLER_CREATE_FIELD_LIST_BOX="CreateListBoxStateHandler",e.STATE_HANDLER_CREATE_FIELD_DATE="CreateDateStateHandler",e.STATE_HANDLER_CREATE_FIELD_IMAGE="CreateImageStateHandler",e.STATE_HANDLER_SNAPSHOT_TOOL="snapshot-tool",e.STATE_HANDLER_CREATE_DOCUMENT_ATTACHMENT="createDocumentAttachment"}(H||(H={}));var D,P=H.STATE_HANDLER_HAND,L=(H.STATE_HANDLER_CHECK_THE_SEARCH,H.STATE_HANDLER_CREATE_CARET),k=H.STATE_HANDLER_CREATE_ARROW,N=H.STATE_HANDLER_CREATE_AREA_HIGHLIGHT,O=(H.STATE_HANDLER_CREATE_AREA_HIGHLIGHT,H.STATE_HANDLER_CREATE_CIRCLE),I=H.STATE_HANDLER_CREATE_FILE_ATTACHMENT,j=H.STATE_HANDLER_CREATE_HIGHLIGHT,B=H.STATE_HANDLER_CREATE_IMAGE,V=H.STATE_HANDLER_CREATE_LINK,M=H.STATE_HANDLER_CREATE_LINE,F=H.STATE_HANDLER_CREATE_DISTANCE,G=H.STATE_HANDLER_CREATE_PERIMETER,$=H.STATE_HANDLER_CREATE_AREA,U=H.STATE_HANDLER_CREATE_CIRCLE_AREA,X=H.STATE_HANDLER_CREATE_PENCIL,Y=H.STATE_HANDLER_CREATE_POLYGON_CLOUD,K=H.STATE_HANDLER_CREATE_POLYGON,W=H.STATE_HANDLER_CREATE_POLYLINE,z=H.STATE_HANDLER_CREATE_REPLACE,q=H.STATE_HANDLER_CREATE_SQUARE,Q=H.STATE_HANDLER_CREATE_SQUIGGLY,J=H.STATE_HANDLER_CREATE_STAMP,Z=H.STATE_HANDLER_CREATE_STRIKE_OUT,ee=H.STATE_HANDLER_CREATE_TEXT,te=H.STATE_HANDLER_CREATE_UNDERLINE,ne=(H.STATE_HANDLER_MARQUEE,H.STATE_HANDLER_ERASER,H.STATE_HANDLER_LOUPE,H.STATE_HANDLER_SELECT_TEXT_ANNOTATION,H.STATE_HANDLER_SELECT_TEXT_IMAGE,H.STATE_HANDLER_SELECT_ANNOTATION,H.STATE_HANDLER_CREATE_FREETEXT_TYPEWRITER),re=H.STATE_HANDLER_CREATE_FREETEXT_CALLOUT,ie=H.STATE_HANDLER_CREATE_FREETEXT_BOX,oe=(H.STATE_HANDLER_SNAPSHOT_TOOL,H.STATE_HANDLER_CREATE_DOCUMENT_ATTACHMENT,H.STATE_HANDLER_CREATE_FIELD_TEXT,H.STATE_HANDLER_CREATE_FIELD_SIGNATURE,H.STATE_HANDLER_CREATE_FIELD_PUSH_BUTTON,H.STATE_HANDLER_CREATE_RADIO_BUTTON,y(D={},ee,"text"),y(D,j,"highlight"),y(D,Z,"strikeout"),y(D,te,"underline"),y(D,Q,"squiggly"),y(D,z,"strikeout"),y(D,L,"caret"),y(D,ne,"freetext"),y(D,re,"freetext"),y(D,ie,"freetext"),y(D,q,"square"),y(D,O,"circle"),y(D,M,"line"),y(D,k,"line"),y(D,K,"polygon"),y(D,W,"polyline"),y(D,Y,"polygon"),y(D,N,"highlight"),y(D,X,"ink"),y(D,J,"stamp"),y(D,F,"line"),y(D,G,"polyline"),y(D,$,"polygon"),y(D,U,"circle"),y(D,I,"fileattachment"),y(D,B,"screen"),y(D,V,"link"),y(D,"create-multi-media-state","screen"),y(D,"create-redaction-text-image-state","redact"),y(D,"create-redaction-state","redact"),i(457)),ae=a.Deps.jQuery,ce=a.shared.browser.getPtPxRatio,se=a.ViewerEvents.renderPageSuccess,ue=a.ViewerEvents.switchStateHandler,le=a.keyboard,he=le.BuiltinCommand,de=le.BuiltinShortcutContext,fe=a.shared.debounce,pe=a.commons,ve=pe.colorConvertor,Ee=(pe.KeyCodes,pe.KeyboardUtils),ge=(Ee.isMatch,Ee.matchers,function(e){l(i,e);var n=d(i);function i(e,r,o){var a;return t(this,i),(a=n.call(this,e,r,o)).fillSign=!1,a}return r(i,[{key:"initUI",value:function(){var e=this,t=this.$handler=ae('<div class="fwr__graphics-object-handler fwr__text-object-edit"\n        ></div>');this.pageRender.pageHandler.$handler.after(t),t.get(0).__graphics_object_component=this;this.shapeControl=new a.ShapeControl({prestart:function(){return e.onPrestart()},start:function(t,n,r){return e.onStartUpdateShape(t,n,r)},moving:function(t,n,r){var i=r.offsetX,o=r.offsetY;return e.onShapeMoving(t,n,i,o)},update:function(t,n){return e.onShapeUpdating(t,n)},rotate:function(t,n){return e.onRotate(t,n)},end:function(t,n,r,i){return e.onShapeUpdateEnd(t,n,r,i)},afterEnd:function(t){return e.onAfterShapeCtrlEnd(t)},resizable:!0,enableDiagonally:!0,enableFrame:!0,previewer:!0});return t.on("dblclick",(function(){e.unActive(),e.activeCharEdit()})),this.$handler}},{key:"reActive",value:function(){}},{key:"active",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];s(c(i.prototype),"active",this).call(this),this.reActive=function(){e.unActive(),e.active()};var n=this.pageRender.pdfViewer.getEventEmitter();t&&n.emit(w.textObjectActive,this),this.pageRedrawBind&&n.off(se,this.pageRedrawBind),n.on(se,this.pageRedrawBind=function(t){t.index===e.getModel().getPDFPage().getIndex()&&e.reActive()}),n.on(ue,this.switchStateHandlerBind=function(){e.eCharInput&&e.applyEdit()})}},{key:"unActive",value:function(){this.dependences.pdfViewer._setSaveBefore(),s(c(i.prototype),"unActive",this).call(this),this.unActiveCharEdit();var e=this.pageRender.pdfViewer.getEventEmitter();e.off(se,this.pageRedrawBind),e.off(ue,this.switchStateHandlerBind),e.emit(w.textObjectUnActive,this)}},{key:"unActiveCharEdit",value:function(){this.$charEditContainer&&this.$charEditContainer.remove(),this.$charEditContainer=null,this.unswitchBinder&&this.unswitchBinder()}},{key:"applyEdit",value:function(){var e=this;if(!this.eCharInput)return Promise.reject(new Error("text input box has not been initialized!"));var t=this.eCharInput.innerText;"string"!=typeof t&&(t=this.eCharInput.textContent);for(var n="",r=0,i=0;i<t.length;i++){this.eCharInput.innerText=t.substring(0,i+1);for(var o=t[i];("\n"==o||"\r"==o)&&i<t.length;)o=t[++i];var a=this.eCharInput.offsetHeight;void 0!==o&&(n+=0!==r&&r<a?"\n"+o:o),r=a}return t=n.replace(/\u00a0/g," "),this.isApplyEdit=!0,this.setTextChar(t).then((function(){e.unActive()})).finally((function(){e.isApplyEdit=!1}))}},{key:"initCharEditContainer",value:function(){var e,t=this;e=this.fillSign?ae('<div class="fv__text-object-edit-char-container"><div class="fv__text-object-edit-char-mask-layer"></div><div><span class="fv_fillsign-moving"></span><span class="fv__text-object-edit-char-input " contenteditable></span></div></div>'):ae('<div class="fv__text-object-edit-char-container"><div class="fv__text-object-edit-char-mask-layer"></div><span class="fv__text-object-edit-char-input " contenteditable></span></div>'),this.pageRender.$handler.after(e);var n=e.find(".fv__text-object-edit-char-input"),r=n[0];return this.eCharInput=r,n.on("keydown",(function(r){if(!r.shiftKey&&(13===r.keyCode&&(r.preventDefault(),t.applyEdit()),t.fillSign)){var i=e.find(".fv__text-object-edit-char-mask-layer"),o=n[0].getBoundingClientRect().width;i.width()<o+15&&i.css("width",o+15+"px")}})),this.fillSign&&this.bindMovingEvent(e),e}},{key:"activeCharEdit",value:function(e){var t=this;this.isActive=!0;var n=this.$charEditContainer=this.$charEditContainer||this.initCharEditContainer(),r=n.find(".fv__text-object-edit-char-mask-layer"),i=n.find(".fv__text-object-edit-char-input");this.dependences.pdfViewer._setSaveBefore((function(){return t.applyEdit()}));var o=this.graphicsObject,c=o.getRect(),s=this.pageRender,u=s.pdfViewer;return i.off("focus").on("focus",(function(){var e,n=u.getKeyboard(),r=n.activeContext(de.EDIT_TEXT_OBJECT),i=!1;n.withContext(de.EDIT_TEXT_OBJECT,(function(n){i||(e=n.keyup(he.BLUR_EDITTING_TEXT_OBJECT,(function(){var e=t.eCharInput.innerText;"string"!=typeof e&&(e=t.eCharInput.textContent),t.setTextChar(e).then((function(){t.unActive()})),u.getStateHandlerManager().switchTo(P)})))})),t.unswitchBinder=function(){i||(i=!0,r(),e&&e())}})),u.getEventEmitter().on(ue,this.switchStateHandlerBind=function(){t.eCharInput&&t.applyEdit()}),Promise.all([s.getPDFPage(),s.getScale(),s.getRotation()]).then((function(e){var t=S(e,3),n=t[0],r=t[1],i=t[2];return[n.getDeviceRect(c,r,i),n,r,i]})).then((function(i){var c=S(i,4),u=c[0],l=c[1],h=c[2],d=c[3],f=function(){var e=s.$ui[0].getBoundingClientRect(),t=v.getBoundingClientRect();return{maxWidth:e.right-t.left,maxHeight:e.bottom-t.top}};n.css({left:u.left+"px",top:u.bottom+"px"});var p=n.find(".fv__text-object-edit-char-input"),v=p[0];r.css({width:u.right-u.left+"px",height:u.bottom-u.top+"px"});var E=o.getText();E=E.replace(/\u0020/g," "),void 0===e&&(e=E),"string"==typeof v.innerText?v.innerText=E:v.textContent=E;var g=o.getFontSize(),_=o.getMatrix().toArray().slice(0,4),m=12,T=g*ce()<m;T&&(g*=m,_[0]/=m,_[1]/=m,_[2]/=m,_[3]/=m),_[0]*=h,_[1]*=-h,_[2]*=-h,_[3]*=h;var A=new a.Matrix(_[0],_[1],_[2],_[3],0,0),C=l.getRotationAngle()+d;if(A.rotate(C/180*Math.PI),t.fillSign)p.css(y({fontSize:g+"pt",transform:"matrix("+A.toArray().join(",")+")",color:ve(16777215&o.getFillColor(),"#")},"transform","matrix("+A.toArray().join(",")+")"));else{if("TimesNewRoman"===o.info.textState.font.baseName)otherFontName="Times New Roman";p.css({fontFamily:'"'+[o.info.textState.font.baseName,o.info.textState.font.familyName,o.info.textState.font.nameKey,o.info.textState.font.name,"FoxitPDFSDKForWeb"].join('","')+'"',fontSize:g+"pt",fontWeight:o.info.textState.font.isBold?700:400,fontStyle:o.info.textState.font.isItalic?"italic":"",transform:"matrix("+A.toArray().join(",")+")",color:ve(16777215&o.getFillColor(),"#")})}var R,x,H=p.height(),D=p.width(),P=A.transformPoint(D,H),L=P[0],k=P[1];t.fillSign&&t.showToolbar(Math.abs(k)),L>=0&&k>0?(R=-A.transformPoint(D,0)[1]-H,x=0):L<0&&k>=0?(R=-A.transformPoint(D,0)[1]-H,x=-A.transformPoint(0,D)[1]):L<=0&&k<0?(R=A.transformPoint(0,H)[1]-H,x=-L+A.transformPoint(0,H)[0]):L>0&&k<=0&&(R=-A.transformPoint(0,H)[1]-H,x=L-A.transformPoint(D,0)[0]),p.css({top:R+"px",left:x+"px",transformOrigin:"left "+H+"px",bottom:"auto"}),e!==E&&("string"==typeof v.innerText?v.innerText=e:v.textContent=e),t.fillSign||b(o.info.textState.font.nameKey||o.info.textState.font.name,o.getWoff.bind(o)).catch((function(){})),t.reActive=function(e){t.unActive(),t.activeCharEdit(e)};var N=t.pageRender.pdfViewer.getEventEmitter();t.fillSign||N.emit(w.textObjectActive,t),document.activeElement!==v&&v.focus();var O=f(),I=O.maxWidth,j=O.maxHeight,B=T?h/m:h;v.style.cssText+="\n                max-width: ".concat(I/B,"px;\n            ");var V=v.textContent,M=function(){v.style.cssText+="\n                    white-space: pre;\n                    width: auto;\n                ";var e=v.getBoundingClientRect().width;v.style.cssText+="\n                    width: ".concat(Math.min(I,e)/B,"px;\n                    white-space: pre-line;\n                ");var t=(0,oe.getCursorPositionOfEditableElement)(v);v.getBoundingClientRect().height>j?(v.textContent=V,(0,oe.moveCursorTo)(v,t)):V=v.textContent},F=!1;v.addEventListener("input",(function(){F||M()})),v.addEventListener("compositionstart",(function(){F=!0,v.style.maxWidth=I/h+"px"}));var G=fe(M,0);v.addEventListener("compositionupdate",(function(){G()})),v.addEventListener("compositionend",(function(){F=!1,v.style.maxWidth="",M()})),t.pageRedrawBind&&N.off(se,t.pageRedrawBind),N.on(se,t.pageRedrawBind=function(n){if(n.index===t.getModel().getPDFPage().getIndex()){e="string"==typeof v.innerText?v.innerText:v.textContent;var r=f(),i=r.maxWidth,o=r.maxHeight;I=i,j=o;var a=T?n.scale/m:n.scale;v.style.cssText+="\n                        max-width: ".concat(I/a,"px;\n                    ")}})}))}},{key:"showToolbar",value:function(e){}},{key:"setTextChar",value:function(e){return this.graphicsObject.setText(e)}},{key:"getContextMenuConfig",value:function(){}},{key:"getTextChar",value:function(){if(this.$charEditContainer){var e=this.$charEditContainer.find(".fv__text-object-edit-char-input")[0],t=e.innerText;return"string"!=typeof t&&(t=e.textContent),t.replace(/\u00a0/g," ")}return this.getModel().getText()}},{key:"textCharSure",value:function(){return!this.isApplyEdit&&this.$charEditContainer?this.fillSign?this.saveFillSign():this.applyEdit():Promise.resolve()}},{key:"remove",value:function(){return s(c(i.prototype),"remove",this).call(this),this.dependences.pdfViewer.unActiveElement(this),this.destroy(),this.graphicsObject.remove()}}]),i}(A));function _e(e){if("clientX"in e)return e.clientX;switch(e.type){case"touchstart":case"touchmove":return e.touches[0].clientX;case"touchend":case"touchcancel":return e.changedTouches[0].clientX}}function me(e){if("clientY"in e)return e.clientY;switch(e.type){case"touchstart":case"touchmove":return e.touches[0].clientY;case"touchend":case"touchcancel":return e.changedTouches[0].clientY}}var Te=a.Deps.jQuery,Ae=a.commons.colorConvertor,ye=function(e){l(i,e);var n=d(i);function i(e,r,o){return t(this,i),n.call(this,e,r,o)}return r(i,[{key:"active",value:function(){s(c(i.prototype),"active",this).call(this)}},{key:"getPropertyOptions",value:function(){var e=this.graphicsObject,t=e.getBorderColor();t=this.graphicsObject.needStroke()?Ae(t||4278190080,"#"):0;var n=e.getFillColor();0==e.getFillMode()&&(n=0);var r=e.getBorderWidth();return{color:t,borderTransparent:!0,opacity:e.getOpacity(),fillColor:n,borderWidth:r}}},{key:"initUI",value:function(){var e=this;s(c(i.prototype),"initUI",this).call(this),this.$tip=Te('<div class="fwr__path-object-tip"></div>'),this.$tip.appendTo(this.$handler);var t=this.rectHammer=new Hammer.Manager(this.$handler[0],{recognizers:[[Hammer.Press]]});return this.$handler.on("mousemove",(function(t){e.$tip.hide()})),t.on("press",(function(t){if(!Te(".fv__ui-mobile").length){var n=e.graphicsObject.getRect(),r=Ce(e.$handler.parent()[0],t),i={left:r.x+"px",top:r.y+20+"px"};r=e.pageRender.page.reverseDevicePoint([r.x,r.y],e.pageRender.getScale(),e.pageRender.getRotation()),e.$tip.show().css(i).html("object : x:".concat(n.left.toFixed(2),",y:").concat(n.bottom.toFixed(2))+"<br/>mouse: x:".concat(r[0].toFixed(2),",y:").concat(r[1].toFixed(2)))}})),this.$handler}},{key:"showPropertiesDialog",value:function(e){var t=this.dependences.pdfViewer.activePropertiesDialog;this.dependences.pdfViewer.activePropertiesDialog?(t.show(e),t.setViewerComponent(this),this.activePropertiesDialog=t):this.propertiesControl=new a.PropertiesControl(this)}},{key:"getContextMenuComponentName",value:function(){return"fv--path-graphics-object-contextmenu"}},{key:"getContextMenuConfig",value:function(){var e=this;return{selector:"div.fv__shape-control",items:{properties:{name:"properties",nameI18nKey:"viewer_:contextmenu.annot.properties",callback:function(t,n,r){e.showPropertiesDialog(r)}},remove:{name:"delete",nameI18nKey:"viewer_:contextmenu.annot.delete",callback:function(){e.remove()}}}}}},{key:"unActive",value:function(e){var t=this.activePropertiesDialog;t&&t.viewerComponent===this&&t.hide(),s(c(i.prototype),"unActive",this).call(this,e)}},{key:"remove",value:function(){return s(c(i.prototype),"remove",this).call(this),this.dependences.pdfViewer.unActiveElement(this),this.destroy(),this.graphicsObject.remove()}},{key:"destroy",value:function(){this.contextmenu&&this.contextmenu.destroy(),this.propertiesControl&&this.propertiesControl.close(),this.propertiesControl=null,this.rectHammer&&this.rectHammer.destroy(),s(c(i.prototype),"destroy",this).call(this)}}]),i}(A),Ce=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=_e(r),o=me(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}},Re=a.Deps.jQuery,Se=a.Events,we=function(e){l(i,e);var n=d(i);function i(){return t(this,i),n.apply(this,arguments)}return r(i,[{key:"_resize",value:function(e,t,n){this.enableUniform="north"!=e&&"south"!=e&&"east"!=e&&"west"!=e,s(c(i.prototype),"_resize",this).call(this,e,t,n)}}]),i}(a.ShapeControl),be=function(n){l(o,n);var i=d(o);function o(e,n,r){return t(this,o),i.call(this,e,n,r)}return r(o,[{key:"initUI",value:function(){var e=this,t=this,n=this.$handler=Re('<div class="fwr__graphics-object-handler" \n        ></div>');return this.pageRender.pageHandler.$handler.append(n),n.get(0).__graphics_object_component=this,this.shapeControl=new we({prestart:function(){return e.onPrestart()},start:function(t,n,r){return e.onStartUpdateShape(t,n,r)},moving:function(t,n,r){var i=r.offsetX,o=r.offsetY;return e.onShapeMoving(t,n,i,o)},update:function(t,n){return e.onShapeUpdating(t,n)},beforeRotateStart:function(){return e.onBeforeRotateStart()},rotateEnd:function(t,n,r,i){return e.onRotate(t)},afterRotateEnd:function(){return e.onAfterRotateEnd()},rotateStart:function(){return e.onRotateStart()},end:function(t,n,r,i){return e.onShapeUpdateEnd(t,n,r,i)},afterEnd:function(t){return e.onAfterShapeCtrlEnd(t)},resizable:!0,rotatable:!0,enableDiagonally:!0,enableFrame:!0,enableUniform:!0,previewer:!0,enableSizeBox:!0}),this.dependences.pdfViewer.eventEmitter.on(Se.zoomToSuccess,this.afterZoom=function(){t.updateShapeControl()}),this.$handler}},{key:"onBeforeRotateStart",value:function(){var t=this;this.dependences.pdfViewer.getAllActiveElements().forEach((function(n){n!==t&&e(n,o)&&t.shapeControl.companion(n.shapeControl)}))}},{key:"onAfterRotateEnd",value:function(){this.shapeControl.rotateDegree=0,this.shapeControl.companions.forEach((function(e){return e.rotateDegree=0})),this.shapeControl.clearCompanions()}},{key:"onRotate",value:function(e){var t=this;return this.pageRender.$handler.get(0).classList.remove("fv__cursor-rotation"),this.graphicsObject.setRotation(e).then((function(e){t.updateShapeControl()}))}},{key:"updateShapeControl",value:function(){s(c(o.prototype),"updateShapeControl",this).call(this),this.shapeControl.ui.style.transform=""}},{key:"onRotateStart",value:function(){this.pageRender.$handler.get(0).classList.add("fv__cursor-rotation")}},{key:"getContextMenuConfig",value:function(){var e=this;return{selector:"div.fv__shape-control",items:{properties:{name:"properties",nameI18nKey:"viewer_:contextmenu.annot.properties",callback:function(t,n,r){e.showPropertiesDialog(r)}},remove:{name:"delete",nameI18nKey:"viewer_:contextmenu.annot.delete",callback:function(){var t=e.dependences.pdfViewer;if(t.getAllActiveElements().forEach((function(e){e.remove&&e.remove()})),0===t.getAllActiveElements().length){var n=t.getCurrentActivatable();n&&t.unActiveElement(n)}}}}}}},{key:"getContextMenuComponentName",value:function(){return"fv--image-graphics-object-contextmenu"}},{key:"getPropertyOptions",value:function(){return{opacity:this.graphicsObject.getOpacity(),borderStyle:!1}}},{key:"showPropertiesDialog",value:function(e){var t=this.dependences.pdfViewer.activePropertiesDialog;this.dependences.pdfViewer.activePropertiesDialog?(t.show(e),t.setViewerComponent(this),this.activePropertiesDialog=t):this.$propertiesControl=new a.PropertiesControl(this)}},{key:"hidePropertiesDialog",value:function(){this.$propertiesControl&&this.$propertiesControl.close()}},{key:"destroy",value:function(){this.contextmenu&&this.contextmenu.destroy(),this.dependences.pdfViewer.eventEmitter.off(Se.zoomToSuccess,this.afterZoom),s(c(o.prototype),"destroy",this).call(this)}},{key:"setOpacity",value:function(e){this.graphicsObject.setOpacity(e)}},{key:"remove",value:function(){s(c(o.prototype),"remove",this).call(this),this.graphicsObject.remove(),this.dependences.pdfViewer.unActiveElement(this),this.destroy()}},{key:"unActive",value:function(e){var t=this.activePropertiesDialog;t&&t.viewerComponent===this&&t.hide(),s(c(o.prototype),"unActive",this).call(this,e)}}]),o}(A),xe=(function(e){l(i,e);var n=d(i);function i(e,r,o){return t(this,i),n.call(this,e,r,o)}r(i,[{key:"active",value:function(){}},{key:"getContextMenuConfig",value:function(){}}])}(A),function(){function e(){t(this,e),this.matchRules=[]}return r(e,[{key:"registerMatchRule",value:function(e){return this.matchRules.push(e),e}},{key:"unRegisterMatchRule",value:function(e){var t=this.matchRules.indexOf(e);-1!==t&&this.matchRules.splice(t,1)}},{key:"get",value:function(e){for(var t=this.matchRules,n=this.getDefault(e),r=t.length;r--;){var i=t[r];if("function"==typeof i){var o=i(e,n);if(o)return o}}return n}},{key:"getDefault",value:function(e){switch(e.getType()){case 1:return ge;case 2:return ye;case 3:return be;default:return A}}}]),e}()),He=a.Deps.Hammer;function De(e,n){var i=e.graphicsManager,o=["","text","path","image","shading","all"][n],c=o?["fv__edit-",o,"-state-handler"].join(""):"";return c+=" fv__edit-graphics-state-handler",function(a){l(u,a);var s=d(u);function u(e){return t(this,u),s.call(this,e)}return r(u,[{key:"pageHandler",value:function(t){var r=this;this.pageRender=t;var o=t.getPDFPage(),a=t.$handler,s=a[0];a.addClass(c),(this.hammer=new He(s)).on("tap",(function(a){if(-1!=a.target.className.indexOf("fv__shape-control-move-area"))return Promise.resolve();r.resetHandler();var c=Pe(s,a);o.then((function(e){return[e,e.reverseDevicePoint([c.x,c.y],t.getScale(),t.getRotation())]})).then((function(e){var t=S(e,2),r=t[0],i=S(t[1],2),o=i[0],a=i[1];return 5===n?r.getGraphicsObjectAtPoint([o,a],5,0):r.getGraphicsObjectAtPoint([o,a],3,n)})).then((function(e){return!e||e.type<1||e.type>3?Promise.reject():[i.get(e),e]})).then((function(n){var r=S(n,2);return new(0,r[0])(r[1],t,e)})).then((function(e){return r.currentComponent=e,e.active()})).catch((function(e){e&&console.error(e),r.currentComponent=null,r.pdfViewer.activeElement()}))}))}},{key:"destroyPageHandler",value:function(){this.unregisterKeyEvent&&this.unregisterKeyEvent(),this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(c),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponent&&(this.currentComponent.textCharSure&&this.currentComponent.textCharSure(),this.currentComponent.unActive())}}],[{key:"getStateName",value:function(){return"edit-"+o}}]),u}(a.IStateHandler)}var Pe=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=_e(r),o=me(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}},Le=a.Deps.Hammer;function ke(e){return function(e){if(Array.isArray(e))return C(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||R(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var Ne=function(){function e(){t(this,e)}return r(e,null,[{key:"pointsToRect",value:function(e,t,n){var r=e.x>t.x?t.x:e.x,i=e.x<t.x?t.x:e.x,o=e.y>t.y?t.y:e.y,a=e.y<t.y?t.y:e.y;if(n){var c=o;(o=a)-(a=c)<1&&(o=a+1,a-=1)}else a-o<1&&(a=o+1,o-=1);return i-r<1&&(i=r+1,r-=1),{left:r-2,top:a+1,right:i+2,bottom:o-1}}},{key:"generatePoints",value:function(t,n,r){var i=t.x,o=t.y,a=n.x-i,c=n.y-o;switch(r){case"line":return e.genLinePoints(i,o,a,c);case"square":return e.genSquarePoints(i,o,a,c);case"circle":return e.genOvalPoints(i,o,a,c);case"roundRect":return e.genRoundRectPoints(i,o,a,c)}}},{key:"genLinePoints",value:function(e,t,n,r){var i=[];return i.push(["m",e,t]),i.push(["l",e+n,t+r]),i}},{key:"genOvalPoints",value:function(e,t,n,r){var i=[];return i.push(["m",e+n/2,t]),(i=(i=(i=(i=i.concat(Oe(e+n/2,t,n/2,r/2,1))).concat(Oe(e+n,t+r/2,-n/2,r/2,0))).concat(Oe(e+n/2,t+r,-n/2,-r/2,1))).concat(Oe(e,t+r/2,n/2,-r/2,0))).push(["h",i[0][1],i[0][2]]),i}},{key:"genRoundRectPoints",value:function(e,t,n,r){var i=[],o=.2*n,a=.2*r,c=.8*n,s=.8*r;return i.push(["m",e+o,t]),i.push(["l",e+c,t]),(i=i.concat(Oe(e+c,t,o,a,1))).push(["l",e+n,t+s]),(i=i.concat(Oe(e+n,t+s,-o,a,0))).push(["l",e+o,t+r]),(i=i.concat(Oe(e+o,t+r,-o,-a,1))).push(["l",e,t+a]),(i=i.concat(Oe(e,t+a,o,-a,0))).push(["l",i[0][1],i[0][2]]),i.push(["h"]),i}},{key:"genSquarePoints",value:function(e,t,n,r){var i=[];return i.push(["m",e,t]),i.push(["l",e+n,t]),i.push(["l",e+n,t+r]),i.push(["l",e,t+r]),i.push(["h",e,t]),i}}]),e}();function Oe(e,t,n,r,i){var o=[],a=.5522847498308;return i?(o.push(["c",e+a*n,t]),o.push(["c",e+n,t+a*r]),o.push(["c",e+n,t+r])):(o.push(["c",e,t+a*r]),o.push(["c",e+a*n,t+r]),o.push(["c",e+n,t+r])),o}var Ie=a.Deps.jQuery,je=a.Deps.Hammer,Be=a.IStateHandler,Ve=function e(){t(this,e),this.addon=null,this.pathType=0,this.canAdd=!1},Me=function(e){l(i,e);var n=d(i);function i(e){var r;return t(this,i),(r=n.call(this,e)).destroyHooks=[],r}return r(i,[{key:"addDestroyHook",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r;(r=this.destroyHooks).push.apply(r,ke(t))}},{key:"addEventTo",value:function(e,t,n){return e.on(t,n),function(){e.off(t,n)}}},{key:"pageHandler",value:function(e){var t=this;this.pageRender=e;var n,r,i=e.pdfViewer.getIoC().getInstanceByClass(Ve),o=e.$handler;o.addClass("fv__create-callout-state-handler "+this.cursorStyle),this.shapeDom=(0==(r=(n=o).find(".fv__add-path-preview")).length&&(r=Ie('<canvas class="fv__add-path-preview" style="position: absolute;display:none"></canvas>'),n.append(r)),r);var a,c,s=o[0],u=this.hammer=new je.Manager(s,{recognizers:[[je.Pan,{direction:je.DIRECTION_ALL}]]}),l=function(e){i.canAdd=-1!=e.target.className.indexOf("fv__pdf-page-handler-container")};this.addDestroyHook(this.addEventTo(o,"mousedown",l),this.addEventTo(o,"touchstart",l),(function(){u.destroy()})),u.on("panstart",(function(e){i.canAdd&&(a=Fe(s,e))})).on("panend",(function(n){if(a){c={x:a.x+n.deltaX,y:a.y+n.deltaY};var r=t.pageRender.page.reverseDevicePoint([a.x,a.y],t.pageRender.getScale(),t.pageRender.getRotation()),o=t.pageRender.page.reverseDevicePoint([c.x,c.y],t.pageRender.getScale(),t.pageRender.getRotation()),s={x:r[0],y:r[1]},u={x:o[0],y:o[1]},l=Ne.generatePoints(s,u,i.pathType),h=Ne.pointsToRect(s,u);t.pageRender.page.addGraphicsObject({type:2,points:l,rect:h}).then((function(e){return a=null,t.shapeDom.hide(),e})).then((function(e){return e?[i.addon.graphicsManager.get(e),e]:Promise.reject(new Error("Graphics object was not created!"))})).then((function(t){var n=S(t,2);return new(0,n[0])(n[1],e,i.addon)})).then((function(e){t.currentComponet=e,t.pdfViewer.activeElement(e)})).catch((function(e){throw t.currentComponet=null,t.pdfViewer.activeElement(),e}))}})).on("panmove",(function(e){if(a){c={x:a.x+e.deltaX,y:a.y+e.deltaY};var n=Ne.pointsToRect(a,c,!0);!function(e,t,n){var r=n[0],i=r.getContext("2d");i.clearRect(0,0,n.width(),n.height()),r.width=t.right-t.left+4,r.height=t.bottom-t.top+4,i.clearRect(0,0,n.width(),n.height()),i.beginPath(),i.lineWidth=2,i.strokeStyle="#5aa",i.transform(1,0,0,1,2-t.left,2-t.top);for(var o=[],a=0;a<e.length;a++)switch(e[a][0]){case"m":i.moveTo(e[a][1],e[a][2]);break;case"l":i.lineTo(e[a][1],e[a][2]);break;case"c":o.push(e[a][1],e[a][2]),6===o.length&&(i.bezierCurveTo(o[0],o[1],o[2],o[3],o[4],o[5]),o=[]);break;case"h":4===o.length?(i.bezierCurveTo(o[0],o[1],o[2],o[3],e[a][1],e[a][2]),o=[]):i.lineTo(e[a][1],e[a][2]),i.closePath()}i.stroke(),n.css({left:t.left,top:t.top}).show()}(Ne.generatePoints(a,c,i.pathType),n,t.shapeDom)}}))}},{key:"destroyPageHandler",value:function(){this.destroyHooks.forEach((function(e){return e()})),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponet&&this.currentComponet.destroy()}}],[{key:"setAddon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e?e.pdfViewer:null;t&&(t.getIoC().getInstanceByClass(Ve).addon=e)}},{key:"getStateName",value:function(){return"add-path-object"}},{key:"setPathType",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;e.getIoC().getInstanceByClass(Ve).pathType=t}}]),i}(Be),Fe=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=_e(r),o=me(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}};function Ge(e,t,n,r,i,o,a){try{var c=e[o](a),s=c.value}catch(e){return void n(e)}c.done?t(s):Promise.resolve(s).then(r,i)}function $e(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function a(e){Ge(o,r,i,a,c,"next",e)}function c(e){Ge(o,r,i,a,c,"throw",e)}a(void 0)}))}}function Ue(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,c[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&c[0]?r.return:c[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,c[1])).done)return i;switch(r=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,r=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){a.label=c[1];break}if(6===c[0]&&a.label<i[1]){a.label=i[1],i=c;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(c);break}i[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],r=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;var Xe=a.Deps.jQuery,Ye=a.IStateHandler,Ke=a.Events,We=a.shared.QueuedAsyncTaskExecutor,ze=function e(){t(this,e),this.addon=null},qe=function(e){l(i,e);var n=d(i);function i(e){return t(this,i),n.call(this,e)}return r(i,[{key:"pageHandler",value:function(e){var t=this;this.pageRender=e;var n,r,i=this.pdfViewer.getIoC().getInstanceByClass(ze),o=this.$handler=e.$handler,a=o[0],c=this.hammer=new Hammer.Manager(a,{recognizers:[[Hammer.Tap],[Hammer.Pan,{direction:Hammer.DIRECTION_ALL}]]}),s=new We;function u(){return l.apply(this,arguments)}function l(){return(l=$e((function(){var t,i,a,c,s,u,l,h;return Ue(this,(function(d){switch(d.label){case 0:return r?[2,r]:[4,Ze(n)];case 1:return t=d.sent(),i=t.width,a=t.height,c=e.getRotation(),s=3*i/e.page.getPxWidth(),u=3*a/e.page.getPxHeight(),(s>1||u>1)&&((l=Math.max(s,u))>1&&(l=1/l),i*=l,a*=l),90!==c&&270!==c||(h=i,i=a,a=h),r=Xe('<img style="position: absolute;top:200%;left:0;border:2px solid transparent; width:'.concat(i,"px; height:").concat(a,'px" src="').concat(n,'"/>')),o.append(r),[2,r]}}))}))).apply(this,arguments)}this.pdfViewer.eventEmitter.on(Ke.addEditImage,this.loadFile=function(e){n=e}),o.off("mouseenter").on("mouseenter",(function(e){n&&s.exec($e((function(){return Ue(this,(function(e){switch(e.label){case 0:return[4,u()];case 1:return e.sent().show(),[2]}}))})))})),o.off("mousemove mousewheel").on("mousemove mousewheel",(function(e){if(n){var t=a.getBoundingClientRect(),r=e.clientX-t.left,i=e.clientY-t.top;s.exec($e((function(){return Ue(this,(function(e){switch(e.label){case 0:return[4,u()];case 1:return e.sent().css({top:i,left:r}),[2]}}))})))}})),o.off("mouseleave").on("mouseleave",(function(e){n&&s.exec($e((function(){return Ue(this,(function(e){switch(e.label){case 0:return[4,u()];case 1:return e.sent().hide(),[2]}}))})))}));var h,d=!0,f=this;c.on("tap",(h=$e((function(r){var o,c,s,l,h;return Ue(this,(function(p){switch(p.label){case 0:return d?(d=!1,n?(o={},c=Qe(a,r),[4,u()]):[2]):[2];case 1:return s=p.sent(),l=s.width(),h=s.height(),e.getPDFPage().then((function(r){var a,u=e.getRotation(),p=3*l/r.getPxWidth(),v=3*h/r.getPxHeight();if(p>1||v>1){var E=Math.max(p,v);E>1&&(E=1/E),l*=E,h*=E}if(90===u||270===u){var g=l;l=h,h=g}o.top=c.y,o.left=c.x,o.right=o.left+l,o.bottom=o.top+h,(a=n,new Promise((function(e,t){var n=new XMLHttpRequest;n.open("GET",a),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(n.status>=200&&n.status<300||304===n.status?e(n.response):t())},n.onerror=function(){t()},n.send()}))).then((function(n){var a=r.reverseDeviceRect(o,e.getScale(),u);r.addImage(n,a,u).then((function(t){if(!t)return f.pdfViewer.getStateHandlerManager().switchTo("edit-all"),s.remove(),f.currentComponet=null,void f.pdfViewer.activeElement();var n=new(i.addon.graphicsManager.get(t))(t,e,i.addon);f.pdfViewer.getStateHandlerManager().switchTo("edit-all"),f.currentComponet=n,s.remove(),d=!0,f.pdfViewer.activeElement(n)})).catch((function(e){e&&console.error(e),t.currentComponet=null,t.pdfViewer.activeElement()}))}))})),[2]}}))})),function(e){return h.apply(this,arguments)}))}},{key:"destroyPageHandler",value:function(){this.$handler.off("mousemove mousewheel mouseleave"),this.$handler.empty(),this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(this.cursorStyle),this.pdfViewer.eventEmitter.off(Ke.addEditImage,this.loadFile)}},{key:"out",value:function(){this.destroyPageHandler()}}],[{key:"setAddon",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e?e.pdfViewer:null;t&&(t.getIoC().getInstanceByClass(ze).addon=e)}},{key:"getStateName",value:function(){return"add-image-object"}}]),i}(Ye),Qe=function(e,t){var n=e.getBoundingClientRect(),r=t.srcEvent,i=_e(r),o=me(r);return{x:i-n.left-t.deltaX,y:o-n.top-t.deltaY}};var Je=new Map;function Ze(e){return Je.has(e)?Promise.resolve(Je.get(e)):new Promise((function(t,n){var r=new Image;r.setAttribute("crossOrigin","Anonymous"),r.onload=function(){var n=r.width,i=r.height;Je.set(e,{imageURL:e,width:n,height:i}),t({imageURL:e,width:n,height:i})},r.onerror=function(){n("Fail to load image:"+e)},r.src=e}))}var et,tt="fv__add-text-object-state-handler",nt=a.Deps.Hammer;!function(e){e[e.ALL=0]="ALL",e[e.TEXT=1]="TEXT",e[e.PATH=2]="PATH",e[e.IMAGE=3]="IMAGE",e[e.SHADING=4]="SHADING",e[e.FORM_X_OBJECT=5]="FORM_X_OBJECT"}(et||(et={}));var rt=a.shared.areaSelections,it=rt.Selections,ot=rt.SelectionEventType,at=rt.createAreaLimitationReducer,ct=rt.BorderStyle,st=a.Deps.Hammer,ut=a.shared.activation.ActivationGroup,lt=a.shared.keyboardStatus,ht=a.shared.QueuedAsyncTaskExecutor,dt={};function ft(e){var n=e.graphicsManager,i="fv__edit-all-state-handler fv__edit-graphics-state-handler";return function(o){l(s,o);var c=d(s);function s(e){var n;return t(this,s),(n=c.call(this,e)).destroyHooks=[],n}return r(s,[{key:"pageHandler",value:function(t){var r=this,o=new ut;this.pageRender=t;var c=t.getPDFPage(),s=t.$handler,u=s[0];s.addClass(i);var l=new ht;this.selections=new it({anchorElement:u,borderStyle:ct.DOTTED}),this.selections.reducer(at(u)),this.selections.reducer((function(e){if(void 0!==e){var t=u.getBoundingClientRect();return Object.assign({left:e.clientLeft-t.left,top:e.clientTop-t.top},e)}})),this.selections.eventInterceptor((function(e){return e.target===u}));var h=!1;this.selections.eventInterceptor((function(e){return h}));var d=function(e){h=e.target===u};u.addEventListener("mousedown",d),u.addEventListener("touchstart",d),this.destroyHooks.push((function(){u.removeEventListener("mousedown",d),u.removeEventListener("touchstart",d)})),this.selections.on(ot.END,(function(i){l.exec((function(){return c.then((function(c){var s=r.pageRender.scale,u=r.pageRender.getRotation(),l=c.reverseDeviceRect({left:i.left,right:i.left+i.width,top:i.top,bottom:i.top+i.height},s,u),h=Math.min(2/r.pageRender.scale,2);return c.getGraphicsObjectsInRect(l,h,et.ALL).then((function(i){!i||i.length<1||(p()||o.clear(),r.pdfViewer.activeElement(o),i.forEach((function(r){var i=r.getRect();if(!(i.right-i.left<1||i.top-i.bottom<1)){var a=new(n.get(r))(r,t,e);o.add(a)}})),r.pdfViewer.eventEmitter.emit(a.Events.activeElementChanged))}))}))}))}));var f=this.hammer=new st(u);f.on("tap",(function(i){r.resetHandler();var s,l,h,d,f,v=(s=i,l=u.getBoundingClientRect(),h=s.srcEvent,d=_e(h),f=me(h),{x:d-l.left-s.deltaX,y:f-l.top-s.deltaY});c.then((function(e){return[e,e.reverseDevicePoint([v.x,v.y],t.getScale(),t.getRotation())]})).then((function(e){var t=S(e,2),n=t[0],r=S(t[1],2),i=r[0],o=r[1];return n.getGraphicsObjectAtPoint([i,o],5,0)})).then((function(e){return e?e.type<1||e.type>3?Promise.reject():[n.get(e),e]:Promise.reject(dt)})).then((function(n){var r=S(n,2);return new(0,r[0])(r[1],t,e)})).then((function(e){if(r.currentComponent=e,p()){var t=i.target.closest(".fwr__graphics-object-handler");if(t){var n=o.activations.find((function(e){return!!e.$handler&&e.$handler.get(0)===t}));if(n)return o.remove(n),void r.pdfViewer.activeElement(o)}}else o.clear();o.add(e),r.pdfViewer.activeElement(o),r.pdfViewer.eventEmitter.emit(a.Events.tapGraphicsObject,e.getGraphicsObject())})).catch((function(e){e===dt&&p()||(e!==dt&&e&&console.error(e),r.currentComponent=null,r.pdfViewer.activeElement())}))})),this.destroyHooks.push((function(){return f.destroy()}),(function(){return r.selections.destroy()}),(function(){o.clear(),r.pdfViewer.unActiveElement(o)}));var p=function(){return!!r.pdfViewer.isShortcutKeyEnabled()&&(a.DeviceInfo.isMac?lt.isWin:lt.isCtrl)}}},{key:"destroyPageHandler",value:function(){this.hammer&&this.hammer.destroy(),this.destroyHooks.forEach((function(e){return e()})),this.pageRender.$handler.removeClass(i),this.resetHandler(),this.pageRender=null,this.destroyHooks=null}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponent&&this.currentComponent.textCharSure&&this.currentComponent.textCharSure()}}],[{key:"getStateName",value:function(){return"edit-all"}}]),s}(a.IStateHandler)}var pt=function(){function e(n){t(this,e),this.pdfViewer=n,this.graphicsManager=new xe,this.pdfViewer.addon=this}return r(e,[{key:"init",value:function(){var e,n,i,o=this,c=function(e){var n=e.graphicsManager,i="text",o=i?["fv__edit-",i,"-state-handler"].join(""):"";return o+=" fv__edit-graphics-state-handler",function(a){l(s,a);var c=d(s);function s(e){return t(this,s),c.call(this,e)}return r(s,[{key:"pageHandler",value:function(t){var r=this;this.pageRender=t;var i=t.$handler,a=i[0];i.addClass(o);var c=this.hammer=new Le.Manager(a,{recognizers:[[Le.Pan,{direction:Le.DIRECTION_ALL}]]});c.add(new Le.Tap({event:"doubletap",taps:2})),c.add(new Le.Tap({event:"singletap"})),c.get("doubletap").recognizeWith("singletap"),c.get("singletap").requireFailure("doubletap"),c.on("singletap",(function(i){r.resetHandler();var o=i.changedPointers[0];t.getPDFPage().then((function(e){return[e,e.reverseDevicePoint([o.offsetX,o.offsetY],t.getScale(),t.getRotation())]})).then((function(e){var t=S(e,2),n=t[0],r=S(t[1],2),i=r[0],o=r[1];return n.getGraphicsObjectAtPoint([i,o],3,1)})).then((function(e){return e?[n.get(e),e]:Promise.reject(new Error("Text object not found at this position: [".concat(o.offsetX,", ").concat(o.offsetY,"]")))})).then((function(n){var r=S(n,2);return new(0,r[0])(r[1],t,e)})).then((function(e){return r.currentComponet=e,e.active()})).catch((function(e){e&&console.error(e),r.currentComponet=null,r.pdfViewer.activeElement()}))})),c.on("doubletap",(function(i){r.resetHandler();var o=i.changedPointers[0];t.getPDFPage().then((function(e){return[e,e.reverseDevicePoint([o.offsetX,o.offsetY],t.getScale(),t.getRotation())]})).then((function(e){var t=S(e,2),n=t[0],r=S(t[1],2),i=r[0],o=r[1];return n.getGraphicsObjectAtPoint([i,o],3,1)})).then((function(e){return e?[n.get(e),e]:Promise.reject(new Error("Text object not found at this position: [".concat(o.offsetX,", ").concat(o.offsetY,"]")))})).then((function(n){var r=S(n,2);return new(0,r[0])(r[1],t,e)})).then((function(e){return r.currentComponet=e,e.activeCharEdit()})).catch((function(e){e&&console.error(e),r.currentComponet=null,r.pdfViewer.activeElement()}))}))}},{key:"destroyPageHandler",value:function(){this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(o),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.currentComponet&&(this.currentComponet.textCharSure&&this.currentComponet.textCharSure(),this.currentComponet.unActive())}}],[{key:"getStateName",value:function(){return"edit-"+i}}]),s}(a.IStateHandler)}(this),s=De(this,2),u=De(this,3),h=ft(this),f=(n=(e=this).graphicsManager,i=function(){function e(){t(this,e),this.currentEditingGraphicComponent=null}return r(e,[{key:"allInjected",value:function(){var e=this;this.pdfViewer.eventEmitter.on(a.ViewerEvents.willCloseDocument,(function(){e.currentEditingGraphicComponent&&e.currentEditingGraphicComponent.isActive&&e.currentEditingGraphicComponent.unActive(),e.currentEditingGraphicComponent=null}))}},{key:"applyCurrent",value:function(){var e=this.currentEditingGraphicComponent;e&&(e.textCharSure&&e.textCharSure(),e.unActive(),this.currentEditingGraphicComponent=null)}}],[{key:"inject",value:function(){return{pdfViewer:a.PDFViewer}}}]),e}(),function(o){l(s,o);var c=d(s);function s(e){var n;return t(this,s),(n=c.call(this,e)).service=e.getIoC().getInstanceByClass(i),n}return r(s,[{key:"pageHandler",value:function(t){var r=this;this.pageRender=t;var i=t.getPDFPage(),o=t.$handler,c=o[0];o.addClass(tt),(this.hammer=new nt(c)).on("tap",(function(o){r.resetHandler();var c=o.changedPointers[0];i.then((function(e){return[e,e.reverseDevicePoint([c.offsetX,c.offsetY],t.getScale(),t.getRotation())]})).then((function(e){var n=S(e,2),i=n[0],o=S(n[1],2),c=o[0],s=o[1],u=i.getRotationAngle(),l=new a.Matrix;l.rotate((u+t.getRotation())/180*Math.PI),l.translate(c,s);var h=r.pdfViewer.store.getCurrentValue("add-text-object-param-transfer");return i.addGraphicsObject(Object.assign({},h,{originPosition:{x:c,y:s}},{type:1,matrix:l.toArray()}))})).then((function(e){return e?[n.get(e),e]:Promise.reject(new Error("Graphics object was not created!"))})).then((function(n){var r=S(n,2);return new(0,r[0])(r[1],t,e)})).then((function(e){return r.service.currentEditingGraphicComponent=e,r.currentGraphicComponent=e,e.activeCharEdit()})).catch((function(e){e&&console.error(e),r.service.currentEditingGraphicComponent=null,r.currentGraphicComponent=null,r.pdfViewer.activeElement()}))}))}},{key:"destroyPageHandler",value:function(){this.hammer&&this.hammer.destroy(),this.pageRender.$handler.removeClass(tt),this.pdfViewer.getEventEmitter().off(w.addTextObjectParamTransfer,this.addTextObjectParamTransferBind),this.resetHandler()}},{key:"out",value:function(){this.destroyPageHandler()}},{key:"resetHandler",value:function(){this.service.currentEditingGraphicComponent&&this.service.applyCurrent()}}],[{key:"getStateName",value:function(){return"add-text-object"}}]),s}(a.IStateHandler)),p=this.pdfViewer.getStateHandlerManager();[c,s,u,h,Me,f,qe].forEach((function(e){e.setAddon&&e.setAddon(o),p.register(e)})),this.pdfViewer.addDestroyHook((function(){Me.setAddon(null,o.pdfViewer),qe.setAddon(null,o.pdfViewer)}))}},{key:"getGraphicsManager",value:function(){return this.graphicsManager}}]),e}()})(),o})()));